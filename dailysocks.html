<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Daily Socks" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
#wrap {
  margin: 0 auto;
  width: 100%;
  max-width: 789px;
}
.throbber {
  width: 100%;
}
.photo__search {
  position: absolute;
  width: 100%;
  background-color: rgba(255,255,255,0.7);
  margin: 0;
  padding: .5rem 0;
}
.photo__search a {
  margin-left: 1rem;
}
.photo__img {
  width: 100%;
}
.photo__caption {
  margin-top: 0;
}
</style>

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none">
  <symbol id="throbber" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
    <g transform="translate(50 50)">
    <g transform="scale(0.958333 0.958333)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(0 0 0)" stroke="none" fill="#e90c59"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.9166666666666666s"></animateTransform>
    </g><g transform="scale(1 1)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(30 0 0)" stroke="none" fill="#fe718d"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.8333333333333334s"></animateTransform>
    </g><g transform="scale(0.541667 0.541667)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(60 0 0)" stroke="none" fill="#ffe6f5"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.75s"></animateTransform>
    </g><g transform="scale(0.583333 0.583333)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(90 0 0)" stroke="none" fill="#c2dfd7"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.6666666666666666s"></animateTransform>
    </g><g transform="scale(0.625 0.625)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(120 0 0)" stroke="none" fill="#e90c59"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.5833333333333334s"></animateTransform>
    </g><g transform="scale(0.666667 0.666667)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(150 0 0)" stroke="none" fill="#fe718d"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.5s"></animateTransform>
    </g><g transform="scale(0.708333 0.708333)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(180 0 0)" stroke="none" fill="#ffe6f5"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.4166666666666667s"></animateTransform>
    </g><g transform="scale(0.75 0.75)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(210 0 0)" stroke="none" fill="#c2dfd7"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.3333333333333333s"></animateTransform>
    </g><g transform="scale(0.791667 0.791667)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(240 0 0)" stroke="none" fill="#e90c59"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.25s"></animateTransform>
    </g><g transform="scale(0.833333 0.833333)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(270 0 0)" stroke="none" fill="#fe718d"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.16666666666666666s"></animateTransform>
    </g><g transform="scale(0.875 0.875)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(300 0 0)" stroke="none" fill="#ffe6f5"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.08333333333333333s"></animateTransform>
    </g><g transform="scale(0.916667 0.916667)">
    <path d="M0 0L0 -40A40 40 0 0 1 19.999999999999996 -34.64101615137755" transform="rotate(330 0 0)" stroke="none" fill="#c2dfd7"></path>
    <animateTransform attributeName="transform" type="scale" values="1;0.5" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="0s"></animateTransform>
  </g></g>
  </symbol>
</svg>

<div id="wrap"></div>

<script type="x-custom/template" id="photoTemplate">
<div id="t{id}" class="photo">
  <p class="photo__search">
    <a href="{payload.search.yandex}" target="_blank" rel="noreferrer">Yandex Images</a>
    <a href="{payload.search.bing}" target="_blank" rel="noreferrer">Bing Images</a>
    <a href="{payload.search.google}" target="_blank" rel="noreferrer">Google Images</a>
  </p>
  <img src="{payload.params.photo}" alt="{payload.params.caption}" class="photo__img" />
  <p class="photo__caption">{payload.params.caption}</p>
  <p>
  	<input type="text" value="{id}" id="{id}">
  	<button onclick="copyImageID('{id}')">Copy Image_ID</button>
  </p>
</div>
</script>

<script type="x-custom/template" id="photoGroupTemplate">
<div id="t{id}" class="photo_group">
  {html}
  <p>{id}</p>
</div>
</script>

<script>
var searchPrefixes = {
  yandex: 'https://www.yandex.com/images/search?rpt=imageview&url=',
  bing: 'https://www.bing.com/images/search?view=detailv2&iss=sbi&q=imgurl:',
  google: 'https://www.google.com/searchbyimage?image_url='
};

(function () {
  function requestIdleCallback (cb) {
    var start = Date.now();
    return setTimeout(function () {
      cb({
        didTimeout: false,
        timeRemaining: function () {
          return Math.max(0, 50 - (Date.now() - start));
        }
      });
    }, 1);
  }

  if (!(window.requestIdleCallback)) {
    window.requestIdleCallback = requestIdleCallback;
  }
}());

function template (template, obj) {
  var html = template.replace(/\{([^}]+)\}/g, function (interpolation, path) {
    var value = path.split('.').reduce(function (rv, part) {
      if (null === rv) {
        return null;
      }
      return rv[part] ? rv[part] : null;
    }, obj);
    return null === value ? '<i>{no value}</i>' : value;
  });
  return html;
}

function renderPhoto (item) {
  wrap.innerHTML += template(photoTemplate.innerHTML, item);
}

function renderGroup (item) {
  wrap.innerHTML += template(photoGroupTemplate.innerHTML, item);
}

function renderUnknownItem (item) {
  var template = '<hr /><pre><code>' + JSON.stringify(item, undefined, 2) + '</code></pre><hr />';
  wrap.innerHTML += template;
}

function resizeImageIfNeeded (img) {
  if (img.width > img.naturalWidth) {
    img.style.width = img.naturalWidth + 'px';
  }
}

function adjustGroupSizes (arr) {
  var loadedCount = 0;

  function onLoaded (img) {
    if (++loadedCount !== arr.length) {
      return;
    }

    var totalWidth = arr.reduce(function (total, one) {
      return total + one.naturalWidth;
    }, 0);

    arr.forEach(function (img) {
      img.style.width = (Math.round(img.naturalWidth / totalWidth * 100) - 1) + '%';
    });
  }

  arr.forEach(function (img) {
    if (img.complete) {
      onLoaded(img);
    } else {
      img.onload = onLoaded.bind(this, img);
    }
  });
}

function pick (post) {
  if (post && post.payload && post.payload.params && (post.payload.params.photo || post.payload.params.document)) {
    if (post.payload.params.document) {
      post.payload.params.photo = post.payload.params.document;
    }
    post.payload.params.photo = post.payload.params.photo.replace('http://', 'https://');
    post.payload.search = Object.keys(searchPrefixes).reduce(function (rv, item) {
      rv[item] = searchPrefixes[item] + encodeURIComponent(post.payload.params.photo);
      return rv;
    }, {});
    renderPhoto(post);
  } else if (post && post.payload && Array.isArray(post.payload)) {
    post.html = post.payload.map(function (item) {
      return '<img src="' + item.params.photo.replace('http://', 'https://') + '" class="photo__img_group" />';
    }).join('\n');
    renderGroup(post);
  } else {
    renderUnknownItem(post);
  }

  [].forEach.call(document.querySelectorAll('.photo .photo__img'), function (img) {
    if (img.complete) {
      resizeImageIfNeeded(img);
    } else {
      img.onload = resizeImageIfNeeded.bind(this, img);
    }
  });

  [].forEach.call(document.querySelectorAll('.photo_group'), function (div) {
    adjustGroupSizes([].slice.call(div.querySelectorAll('img')));
  });
}

function download () {
  wrap.innerHTML = '<svg class="throbber"><use xlink:href="#throbber" /></svg>';

  var request = new XMLHttpRequest();
  request.onreadystatechange = function () {
    var DONE = this.DONE || 4;
    var responseData = null;
    if (request.readyState === DONE) {
      console.log(request.status, new Date(), request);
      if (200 === request.status) {
        console.log(JSON.parse(request.responseText));

        responseData = JSON.parse(request.responseText);
        requestAnimationFrame(function () {
          function pickMore () {
            requestIdleCallback(function (timing) {
              while (responseData.scheduled.length > 0 && timing.timeRemaining() > 0) {
                pick(responseData.scheduled.shift());
              }

              if (responseData.scheduled.length > 0) {
                pickMore()
              }
            });
          }

          wrap.innerHTML = '';

          pick(responseData.scheduled.shift());
          pick(responseData.scheduled.shift());
          pickMore();
        });
      } else {
        wrap.innerHTML = '<p>Error:</p><pre><code>' + request.responseText + '</code></pre>';
      }
    }
  };
  request.open('GET', 'https://dailysocks.herokuapp.com/dashboard.json', true);
  // request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
  request.send(null);
}

function copyImageID(imageID) {
	var copyText = document.getElementById(imageID);
	copyText.select();
	document.execCommand("copy");
	alert("Copied the text: " + copyText.value);
}



setInterval(download, 15 * 60 * 1000);
download();
</script>
